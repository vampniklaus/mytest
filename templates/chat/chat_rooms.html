{% extends 'base.html' %}
{% load static %}

{% block title %}聊天室 - 二手车交易系统{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-chat-dots"></i> 我的聊天室</h2>
                <a href="{% url 'home' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> 返回首页
                </a>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">聊天室列表</h5>
                </div>
                <div class="card-body p-0">
                    <div id="chat-rooms-list" class="list-group list-group-flush">
                        <div class="text-center py-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="mt-2">正在加载聊天室...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 聊天室列表模板 -->
<template id="chat-room-template">
    <a href="#" class="list-group-item list-group-item-action">
        <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
                <img src="" alt="" class="rounded-circle" width="50" height="50" id="room-avatar">
            </div>
            <div class="flex-grow-1 ms-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-1" id="room-name">聊天室名称</h6>
                    <small class="text-muted" id="room-time">刚刚</small>
                </div>
                <p class="mb-1 text-muted" id="last-message">暂无消息</p>
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted" id="room-type">交易聊天</small>
                    <span class="badge bg-primary rounded-pill" id="unread-count" style="display: none;">0</span>
                </div>
            </div>
        </div>
    </a>
</template>

<!-- 空状态模板 -->
<template id="empty-state-template">
    <div class="text-center py-5">
        <i class="bi bi-chat-dots display-1 text-muted"></i>
        <h4 class="mt-3">暂无聊天室</h4>
        <p class="text-muted">您还没有开始任何聊天，去车辆详情页联系卖家开始聊天吧！</p>
        <a href="{% url 'car_list' %}" class="btn btn-primary">
            <i class="bi bi-car-front"></i> 浏览车辆
        </a>
    </div>
</template>

<style>
.chat-room-item:hover {
    background-color: #f8f9fa;
    cursor: pointer;
}
.chat-room-item.active {
    background-color: #e3f2fd;
    border-left: 4px solid #0d6efd;
}
.unread-badge {
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadChatRooms();
    
    // 每30秒刷新一次聊天室列表
    setInterval(loadChatRooms, 30000);
});

function loadChatRooms() {
    fetch('/chat/api/rooms/')
        .then(response => {
            // 检查响应状态码
            if (response.status === 403) {
                throw new Error('用户未登录或无权访问');
            }
            if (response.status === 302) {
                throw new Error('需要重定向到登录页面');
            }
            
            // 检查响应内容类型
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('text/html')) {
                // 如果返回的是HTML页面，可能是登录页面或错误页面
                return response.text().then(html => {
                    // 检查HTML内容是否包含登录相关的关键词
                    if (html.includes('login') || html.includes('登录') || html.includes('signin')) {
                        throw new Error('用户未登录');
                    } else {
                        throw new Error('服务器返回了HTML页面而不是JSON数据');
                    }
                });
            }
            
            if (!response.ok) {
                throw new Error(`网络响应不正常: ${response.status}`);
            }
            
            return response.json();
        })
        .then(data => {
            if (data && data.rooms !== undefined) {
                displayChatRooms(data.rooms);
            } else {
                throw new Error('服务器返回的数据格式不正确');
            }
        })
        .catch(error => {
            console.error('加载聊天室失败:', error);
            if (error.message.includes('未登录') || error.message.includes('login')) {
                showLoginPrompt();
            } else {
                showError(`加载聊天室失败: ${error.message}`);
            }
        });
}

function displayChatRooms(rooms) {
    const container = document.getElementById('chat-rooms-list');
    
    if (rooms.length === 0) {
        const emptyTemplate = document.getElementById('empty-state-template');
        container.innerHTML = emptyTemplate.innerHTML;
        return;
    }
    
    container.innerHTML = '';
    
    rooms.forEach(room => {
        const template = document.getElementById('chat-room-template');
        const roomElement = template.content.cloneNode(true);
        
        const link = roomElement.querySelector('a');
        link.href = `/chat/${room.room_id}/`;
        link.classList.add('chat-room-item');
        
        // 设置头像
        const avatar = roomElement.querySelector('#room-avatar');
        if (room.other_user && room.other_user.avatar) {
            avatar.src = room.other_user.avatar;
        } else {
            avatar.src = '/static/images/default-avatar.png';
        }
        avatar.alt = room.other_user ? room.other_user.username : '客服';
        
        // 设置房间名称
        const roomName = roomElement.querySelector('#room-name');
        roomName.textContent = room.room_name;
        
        // 设置最后消息时间
        const roomTime = roomElement.querySelector('#room-time');
        roomTime.textContent = formatTime(room.last_message.timestamp || room.updated_at);
        
        // 设置最后消息内容
        const lastMessage = roomElement.querySelector('#last-message');
        lastMessage.textContent = room.last_message.content;
        
        // 设置房间类型
        const roomType = roomElement.querySelector('#room-type');
        roomType.textContent = room.room_type === 'transaction' ? '交易聊天' : '客服咨询';
        
        // 设置未读消息数
        const unreadBadge = roomElement.querySelector('#unread-count');
        if (room.unread_count > 0) {
            unreadBadge.textContent = room.unread_count;
            unreadBadge.style.display = 'inline-block';
            unreadBadge.classList.add('unread-badge');
        }
        
        container.appendChild(roomElement);
    });
}

function formatTime(timestamp) {
    const now = new Date();
    const messageTime = new Date(timestamp);
    const diffMs = now - messageTime;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) {
        return '刚刚';
    } else if (diffMins < 60) {
        return `${diffMins}分钟前`;
    } else if (diffHours < 24) {
        return `${diffHours}小时前`;
    } else if (diffDays < 7) {
        return `${diffDays}天前`;
    } else {
        return messageTime.toLocaleDateString();
    }
}

function showLoginPrompt() {
    const container = document.getElementById('chat-rooms-list');
    container.innerHTML = `
        <div class="text-center py-5">
            <i class="bi bi-person-x display-1 text-muted"></i>
            <h4 class="mt-3">请先登录</h4>
            <p class="text-muted">您需要登录后才能查看聊天室</p>
            <div class="mt-4">
                <a href="/users/login/" class="btn btn-primary me-3">
                    <i class="bi bi-box-arrow-in-right"></i> 立即登录
                </a>
                <a href="/" class="btn btn-outline-secondary">
                    <i class="bi bi-house"></i> 返回首页
                </a>
            </div>
        </div>
    `;
}

function showError(message) {
    const container = document.getElementById('chat-rooms-list');
    container.innerHTML = `
        <div class="text-center py-4">
            <i class="bi bi-exclamation-triangle text-warning display-4"></i>
            <p class="mt-2 text-muted">${message}</p>
            <button class="btn btn-outline-primary" onclick="loadChatRooms()">
                <i class="bi bi-arrow-clockwise"></i> 重新加载
            </button>
        </div>
    `;
}
</script>
{% endblock %}