{% extends 'base.html' %}

{% block title %}AI智能推荐 - 二手车交易系统{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">AI智能推荐</h2>
    
    <!-- 偏好设置区域 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">个性化偏好设置</h5>
        </div>
        <div class="card-body">
            <form id="preferenceForm" method="post">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">偏好品牌</label>
                            {% for brand in brands %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="preferred_brands" value="{{ brand.id }}" id="brand{{ brand.id }}"
                                    {% if user_preference and brand in user_preference.preferred_brands.all %}checked{% endif %}>
                                <label class="form-check-label" for="brand{{ brand.id }}">
                                    {{ brand.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">预算范围</label>
                            <select name="budget_range" class="form-select">
                                <option value="0-5">0-5万</option>
                                <option value="5-10" selected>5-10万</option>
                                <option value="10-20">10-20万</option>
                                <option value="20-50">20-50万</option>
                                <option value="50+">50万以上</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">车辆类型</label>
                            {% for car_type in car_types %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="preferred_types" value="{{ car_type.id }}" id="type{{ car_type.id }}"
                                    {% if user_preference and car_type in user_preference.preferred_types.all %}checked{% endif %}>
                                <label class="form-check-label" for="type{{ car_type.id }}">{{ car_type.name }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">最小年份</label>
                            <input type="number" name="min_year" class="form-control" value="2015" min="2000" max="2024">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">最大里程（万公里）</label>
                            <input type="number" name="max_mileage" class="form-control" value="10" min="0" max="50" step="0.1">
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">保存偏好并获取推荐</button>
            </form>
        </div>
    </div>
    
    <!-- 推荐结果区域 -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">AI推荐结果</h5>
        </div>
        <div class="card-body">
            <div id="recommendationResults">
                <div class="alert alert-info">
                    <h6>请先设置您的偏好，然后点击"保存偏好并获取推荐"按钮</h6>
                    <p class="mb-0">AI将根据您的偏好为您推荐最合适的车辆</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 推荐算法说明 -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">推荐算法说明</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 80px; height: 80px;">
                            <i class="bi bi-graph-up" style="font-size: 2rem;"></i>
                        </div>
                        <h6>协同过滤</h6>
                        <p class="text-muted small">基于相似用户的购买行为为您推荐</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 80px; height: 80px;">
                            <i class="bi bi-tags" style="font-size: 2rem;"></i>
                        </div>
                        <h6>内容推荐</h6>
                        <p class="text-muted small">根据车辆特征与您偏好的匹配度推荐</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="bg-warning text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 80px; height: 80px;">
                            <i class="bi bi-lightning" style="font-size: 2rem;"></i>
                        </div>
                        <h6>实时学习</h6>
                        <p class="text-muted small">根据您的点击和收藏行为持续优化推荐</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // 加载推荐历史
    loadRecommendationHistory();
    
    $('#preferenceForm').on('submit', function(e) {
        e.preventDefault();
        
        // 收集表单数据
        var formData = {
            preferred_brands: [],
            preferred_types: [],
            budget_range: $('select[name="budget_range"]').val(),
            min_year: parseInt($('input[name="min_year"]').val()),
            max_mileage: parseFloat($('input[name="max_mileage"]').val())
        };
        
        // 收集选中的品牌
        $('input[name="preferred_brands"]:checked').each(function() {
            formData.preferred_brands.push($(this).val());
        });
        
        // 收集选中的车型
        $('input[name="preferred_types"]:checked').each(function() {
            formData.preferred_types.push($(this).val());
        });
        
        // 显示加载状态
        $('#recommendationResults').html('<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">加载中...</span></div><p class="mt-2">AI正在为您分析推荐...</p></div>');
        
        // 先保存偏好设置
        $.ajax({
            url: '/ai/save-preferences/',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.status === 'success') {
                    // 偏好保存成功，获取推荐结果
                    getRecommendations();
                } else {
                    showError('保存偏好失败：' + response.message);
                }
            },
            error: function() {
                showError('网络错误，请稍后重试');
            }
        });
    });
    
    function getRecommendations() {
        $.ajax({
            url: '/ai/get-recommendations/',
            type: 'GET',
            success: function(response) {
                if (response.status === 'success') {
                    displayRecommendations(response.recommendations, response.total_count);
                    // 重新加载推荐历史
                    loadRecommendationHistory();
                } else {
                    showError('获取推荐失败：' + response.message);
                }
            },
            error: function() {
                showError('网络错误，请稍后重试');
            }
        });
    }
    
    function displayRecommendations(recommendations, totalCount) {
        if (recommendations.length === 0) {
            $('#recommendationResults').html(`
                <div class="alert alert-warning">
                    <h6>未找到匹配的车辆</h6>
                    <p class="mb-0">请尝试调整您的偏好设置，或查看所有车辆</p>
                </div>
            `);
            return;
        }
        
        var html = `<h6 class="mb-3">为您找到 ${totalCount} 辆匹配车辆</h6>`;
        
        recommendations.forEach(function(car) {
            html += `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <img src="${car.main_image}" alt="${car.brand} ${car.model}" class="img-fluid rounded" style="height: 120px; object-fit: cover;">
                        </div>
                        <div class="col-md-6">
                            <h5>${car.brand} ${car.model}</h5>
                            <p class="mb-1"><strong>年份：</strong>${car.year}年</p>
                            <p class="mb-1"><strong>里程：</strong>${car.mileage}万公里</p>
                            <p class="mb-1"><strong>价格：</strong><span class="text-primary">¥${car.price}万</span></p>
                            <p class="mb-0 text-success"><strong>推荐理由：</strong>${car.reason}</p>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="bg-success text-white rounded-pill px-3 py-2 mb-2">
                                    <strong>匹配度 ${car.matchScore}%</strong>
                                </div>
                                <a href="/cars/${car.id}/" class="btn btn-primary btn-sm">查看详情</a>
                                <button class="btn btn-outline-secondary btn-sm mt-2 toggle-favorite" data-car-id="${car.id}">
                                    <i class="bi bi-heart"></i> 收藏
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
        });
        
        $('#recommendationResults').html(html);
        
        // 绑定收藏按钮事件
        $('.toggle-favorite').on('click', function() {
            var carId = $(this).data('car-id');
            toggleFavorite(carId, $(this));
        });
    }
    
    function loadRecommendationHistory() {
        $.ajax({
            url: '/ai/recommendation-history/',
            type: 'GET',
            success: function(response) {
                if (response.status === 'success' && response.history.length > 0) {
                    displayRecommendationHistory(response.history);
                }
            }
        });
    }
    
    function displayRecommendationHistory(history) {
        var html = `
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">推荐历史</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>车辆</th>
                                <th>匹配度</th>
                                <th>推荐时间</th>
                                <th>状态</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        history.forEach(function(item) {
            var status = '';
            if (item.is_clicked) {
                status = '<span class="badge bg-success">已查看</span>';
            } else if (item.is_viewed) {
                status = '<span class="badge bg-warning">已浏览</span>';
            } else {
                status = '<span class="badge bg-secondary">未查看</span>';
            }
            
            html += `
            <tr>
                <td>${item.car_brand} ${item.car_model}</td>
                <td><span class="badge bg-primary">${item.match_score}%</span></td>
                <td>${item.created_at}</td>
                <td>${status}</td>
            </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        `;
        
        // 添加到页面底部
        $('#recommendationResults').after(html);
    }
    
    function toggleFavorite(carId, button) {
        $.ajax({
            url: `/users/favorites/toggle/${carId}/`,
            type: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.status === 'added') {
                    button.html('<i class="bi bi-heart-fill text-danger"></i> 已收藏');
                    button.removeClass('btn-outline-secondary').addClass('btn-outline-danger');
                } else {
                    button.html('<i class="bi bi-heart"></i> 收藏');
                    button.removeClass('btn-outline-danger').addClass('btn-outline-secondary');
                }
            },
            error: function() {
                showError('收藏操作失败');
            }
        });
    }
    
    function showError(message) {
        $('#recommendationResults').html(`
            <div class="alert alert-danger">
                <h6>操作失败</h6>
                <p class="mb-0">${message}</p>
            </div>
        `);
    }
});
</script>
{% endblock %}